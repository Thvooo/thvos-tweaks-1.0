# THVO Tweaks - Windows 11 Optimization Script
# Run as Administrator

function Show-Menu {
    Clear-Host
    Write-Host "============================================" -ForegroundColor Cyan
    Write-Host "           THVO TWEAKS v1.0" -ForegroundColor Yellow
    Write-Host "       Windows 11 Optimization Tool" -ForegroundColor Yellow
    Write-Host "============================================" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "1.  Disable Unnecessary Services" -ForegroundColor Green
    Write-Host "2.  Disable Startup Programs" -ForegroundColor Green
    Write-Host "3.  Optimize Visual Effects" -ForegroundColor Green
    Write-Host "4.  Disable Telemetry & Data Collection" -ForegroundColor Green
    Write-Host "5.  Disable Windows Search Indexing" -ForegroundColor Green
    Write-Host "6.  Optimize Power Plan (High Performance)" -ForegroundColor Green
    Write-Host "7.  Disable Background Apps" -ForegroundColor Green
    Write-Host "8.  Clean Temp Files" -ForegroundColor Green
    Write-Host "9.  Disable Game Bar & Xbox Features" -ForegroundColor Green
    Write-Host "10. Restore Classic Right-Click Menu" -ForegroundColor Green
    Write-Host "11. Disable Widgets & News Feed" -ForegroundColor Green
    Write-Host "12. Run All Tweaks" -ForegroundColor Magenta
    Write-Host "13. Restore Default Settings" -ForegroundColor Yellow
    Write-Host "0.  Exit" -ForegroundColor Red
    Write-Host ""
    Write-Host "============================================" -ForegroundColor Cyan
}

function Test-Admin {
    $currentUser = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
    return $currentUser.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Disable-UnnecessaryServices {
    Write-Host "`nDisabling unnecessary services..." -ForegroundColor Yellow
    $services = @(
        "DiagTrack",                # Connected User Experiences and Telemetry
        "dmwappushservice",         # WAP Push Message Routing Service
        "SysMain",                  # Superfetch
        "WSearch"                   # Windows Search
    )
    
    foreach ($service in $services) {
        try {
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
            Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
            Write-Host "  [✓] Disabled $service" -ForegroundColor Green
        } catch {
            Write-Host "  [!] Could not disable $service" -ForegroundColor Red
        }
    }
    Write-Host "Services optimization complete!" -ForegroundColor Green
}

function Disable-StartupPrograms {
    Write-Host "`nDisabling startup programs..." -ForegroundColor Yellow
    Get-CimInstance -ClassName Win32_StartupCommand | ForEach-Object {
        Write-Host "  Found: $($_.Name)" -ForegroundColor Gray
    }
    Write-Host "  Use Task Manager > Startup to manage individual programs" -ForegroundColor Cyan
}

function Optimize-VisualEffects {
    Write-Host "`nOptimizing visual effects for performance..." -ForegroundColor Yellow
    $path = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects"
    if (!(Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
    Set-ItemProperty -Path $path -Name VisualFXSetting -Value 2
    Write-Host "  [✓] Visual effects optimized" -ForegroundColor Green
}

function Disable-Telemetry {
    Write-Host "`nDisabling telemetry and data collection..." -ForegroundColor Yellow
    
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name AllowTelemetry -Value 0 -ErrorAction SilentlyContinue
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection" -Name AllowTelemetry -Value 0 -ErrorAction SilentlyContinue
    
    Disable-ScheduledTask -TaskName "Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser" -ErrorAction SilentlyContinue
    Disable-ScheduledTask -TaskName "Microsoft\Windows\Application Experience\ProgramDataUpdater" -ErrorAction SilentlyContinue
    Disable-ScheduledTask -TaskName "Microsoft\Windows\Autochk\Proxy" -ErrorAction SilentlyContinue
    Disable-ScheduledTask -TaskName "Microsoft\Windows\Customer Experience Improvement Program\Consolidator" -ErrorAction SilentlyContinue
    
    Write-Host "  [✓] Telemetry disabled" -ForegroundColor Green
}

function Disable-SearchIndexing {
    Write-Host "`nDisabling Windows Search indexing..." -ForegroundColor Yellow
    Stop-Service -Name "WSearch" -Force -ErrorAction SilentlyContinue
    Set-Service -Name "WSearch" -StartupType Disabled -ErrorAction SilentlyContinue
    Write-Host "  [✓] Search indexing disabled" -ForegroundColor Green
}

function Set-HighPerformancePower {
    Write-Host "`nSetting power plan to High Performance..." -ForegroundColor Yellow
    powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
    Write-Host "  [✓] High Performance power plan activated" -ForegroundColor Green
}

function Disable-BackgroundApps {
    Write-Host "`nDisabling background apps..." -ForegroundColor Yellow
    $path = "HKCU:\Software\Microsoft\Windows\CurrentVersion\BackgroundAccessApplications"
    Set-ItemProperty -Path $path -Name GlobalUserDisabled -Value 1 -ErrorAction SilentlyContinue
    Write-Host "  [✓] Background apps disabled" -ForegroundColor Green
}

function Clean-TempFiles {
    Write-Host "`nCleaning temporary files..." -ForegroundColor Yellow
    
    $tempFolders = @(
        $env:TEMP,
        "C:\Windows\Temp",
        "C:\Windows\Prefetch"
    )
    
    foreach ($folder in $tempFolders) {
        if (Test-Path $folder) {
            Get-ChildItem -Path $folder -Recurse -Force -ErrorAction SilentlyContinue | 
                Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "  [✓] Cleaned $folder" -ForegroundColor Green
        }
    }
    
    Write-Host "  [✓] Temp files cleaned" -ForegroundColor Green
}

function Disable-GameBar {
    Write-Host "`nDisabling Game Bar and Xbox features..." -ForegroundColor Yellow
    
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\GameDVR" -Name AppCaptureEnabled -Value 0 -ErrorAction SilentlyContinue
    Set-ItemProperty -Path "HKCU:\System\GameConfigStore" -Name GameDVR_Enabled -Value 0 -ErrorAction SilentlyContinue
    
    Get-AppxPackage *xbox* | Remove-AppxPackage -ErrorAction SilentlyContinue
    
    Write-Host "  [✓] Game Bar and Xbox features disabled" -ForegroundColor Green
}

function Restore-ClassicContextMenu {
    Write-Host "`nRestoring classic right-click menu..." -ForegroundColor Yellow
    
    New-Item -Path "HKCU:\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" -Force | Out-Null
    Set-ItemProperty -Path "HKCU:\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" -Name "(default)" -Value "" -Force
    
    Write-Host "  [✓] Classic context menu restored (restart Explorer)" -ForegroundColor Green
}

function Disable-Widgets {
    Write-Host "`nDisabling Widgets and News Feed..." -ForegroundColor Yellow
    
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name TaskbarDa -Value 0 -ErrorAction SilentlyContinue
    
    Write-Host "  [✓] Widgets disabled" -ForegroundColor Green
}

function Run-AllTweaks {
    Write-Host "`n========== RUNNING ALL TWEAKS ==========" -ForegroundColor Magenta
    Disable-UnnecessaryServices
    Optimize-VisualEffects
    Disable-Telemetry
    Disable-SearchIndexing
    Set-HighPerformancePower
    Disable-BackgroundApps
    Clean-TempFiles
    Disable-GameBar
    Restore-ClassicContextMenu
    Disable-Widgets
    Write-Host "`n========== ALL TWEAKS COMPLETE ==========" -ForegroundColor Magenta
}

function Restore-Defaults {
    Write-Host "`nRestoring default settings..." -ForegroundColor Yellow
    
    # Re-enable services
    Set-Service -Name "SysMain" -StartupType Automatic -ErrorAction SilentlyContinue
    Set-Service -Name "WSearch" -StartupType Automatic -ErrorAction SilentlyContinue
    
    # Reset power plan
    powercfg -setactive 381b4222-f694-41f0-9685-ff5bb260df2e
    
    Write-Host "  [✓] Default settings restored (some changes require restart)" -ForegroundColor Green
}

# Main script
if (-not (Test-Admin)) {
    Write-Host "ERROR: This script must be run as Administrator!" -ForegroundColor Red
    Write-Host "Please right-click and select 'Run as Administrator'" -ForegroundColor Yellow
    Pause
    exit
}

do {
    Show-Menu
    $choice = Read-Host "`nEnter your choice (0-13)"
    
    switch ($choice) {
        '1' { Disable-UnnecessaryServices }
        '2' { Disable-StartupPrograms }
        '3' { Optimize-VisualEffects }
        '4' { Disable-Telemetry }
        '5' { Disable-SearchIndexing }
        '6' { Set-HighPerformancePower }
        '7' { Disable-BackgroundApps }
        '8' { Clean-TempFiles }
        '9' { Disable-GameBar }
        '10' { Restore-ClassicContextMenu }
        '11' { Disable-Widgets }
        '12' { Run-AllTweaks }
        '13' { Restore-Defaults }
        '0' { 
            Write-Host "`nExiting THVO Tweaks..." -ForegroundColor Cyan
            Start-Sleep -Seconds 1
            exit
        }
        default { Write-Host "`nInvalid choice! Please try again." -ForegroundColor Red }
    }
    
    if ($choice -ne '0') {
        Write-Host "`nPress any key to return to menu..." -ForegroundColor Cyan
        $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
    }
} while ($choice -ne '0')
